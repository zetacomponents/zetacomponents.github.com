<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html 
	xmlns="http://www.w3.org/1999/xhtml"
	xml:lang="en"
	lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<meta name="description" content="Apache Zeta Components - reusable set of high quality PHP components to fasten your development." />
	<meta name="keywords" content="PHP, apache, components, framework, quality" />
	<meta name="author" content="jerome" />
	<meta name="language" content="en" />
	<meta name="date" content="Sun, 10 Jul 2011 11:10:39 +0200" />
	<meta name="robots" content="all" />

	<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" />
	<meta name="DC.title" content="PersistentObject" />
	<meta name="DC.creator" content="jerome" />
	<meta name="DC.date" content="Sun, 10 Jul 2011 11:10:39 +0200" />
	<meta name="DC.rights" content="Copyright" />

	<link rel="meta" href="/zetacomponents/documentation/trunk/PersistentObject/tutorial.rdf" />
	<link rel="icon" href="/zetacomponents/images/favicon.png" type="image/png" />

	<link rel="Stylesheet" type="text/css" href="/zetacomponents/styles/screen.css" media="screen" />
	<link rel="Stylesheet" type="text/css" href="/zetacomponents/styles/print.css" media="print" />


	<title>Apache Zeta Components - high quality PHP components</title>
</head>
<body>
<div id="wcv">
	<h1>
		<a id="header-png" href="/zetacomponents" title="Apache Zeta Components - high quality PHP components">
			Apache Zeta Components - high quality PHP components
		</a>
	</h1>

	<ul class="navigation">
<li >
	<a href="/zetacomponents/news.html" title="About">About</a>
	</li>
<li >
	<a href="/zetacomponents/community/index.html" title="Community">Community</a>
	</li>
<li class="requested">
	<a href="/zetacomponents/documentation/overview.html" title="Documentation">Documentation</a>
	</li>
<li >
	<a href="/zetacomponents/download/index.html" title="Download">Download</a>
	</li>
<li >
	<a href="/zetacomponents/support.html" title="Support">Support</a>
	</li>

</ul>
<ul class="subnavigation">
<li >
	<a href="/zetacomponents/documentation/overview.html" title="Overview">Overview</a>
	</li>
<li >
	<a href="/zetacomponents/documentation/install.html" title="Installation">Installation</a>
	</li>

</ul>

	<div class="content">
    <ul class="tabs">
    <li >
	<a href="/zetacomponents/documentation/trunk/PersistentObject/tutorial.html" title="Tutorial">Tutorial</a>
	</li>
<li >
	<a href="/zetacomponents/documentation/trunk/PersistentObject/phpdoc/classtrees.html" title="API">API</a>
	</li>

</ul>

		<h2>eZ Components - PersistentObject</h2><div class="toc"><h3>Table of Contents</h3><ul><li><p><a href="#introduction">Introduction</a></p></li><li><p><a href="#class-overview">Class overview</a></p></li><li><p><a href="#basic-usage">Basic usage</a></p><ul><li><p><a href="#the-persistent-class">The persistent class</a></p></li><li><p><a href="#the-persistence-mapping">The persistence mapping</a></p></li><li><p><a href="#the-session-object">The session object</a></p></li><li><p><a href="#lazy-initialization">Lazy initialization</a></p></li><li><p><a href="#creating-and-updating-an-object">Creating and updating an object</a></p></li><li><p><a href="#finding-objects">Finding objects</a></p></li><li><p><a href="#deleting-objects">Deleting objects</a></p></li></ul></li><li><p><a href="#identifier-generation">Identifier generation</a></p><ul><li><p><a href="#ezcpersistentsequencegenerator">ezcPersistentSequenceGenerator</a></p></li><li><p><a href="#ezcpersistentnativegenerator">ezcPersistentNativeGenerator</a></p></li><li><p><a href="#ezcpersistentmanualgenerator">ezcPersistentManualGenerator</a></p></li></ul></li><li><p><a href="#definition-loaders">Definition loaders</a></p><ul><li><p><a href="#ezcpersistentcodemanager">ezcPersistentCodeManager</a></p></li><li><p><a href="#extending-the-definition-loader">Extending the definition loader</a></p></li></ul></li><li><p><a href="#relations">Relations</a></p><ul><li><p><a href="#relation-class-overview">Relation class overview</a></p></li><li><p><a href="#relations-basics">Relations basics</a></p></li><li><p><a href="#defining-a-simple-relation">Defining a simple relation</a></p></li><li><p><a href="#using-a-relation">Using a relation</a></p></li><li><p><a href="#defining-n-m-relations">Defining n:m relations</a></p></li><li><p><a href="#using-n-m-relations">Using n:m relations</a></p></li><li><p><a href="#special-1-1-relations">Special 1:1 relations</a></p></li><li><p><a href="#reverse-relations">Reverse relations</a></p></li><li><p><a href="#cascading-deletes">Cascading deletes</a></p></li><li><p><a href="#defining-multiple-relations-to-the-same-php-class">Defining multiple relations to the same PHP class</a></p></li><li><p><a href="#using-multiple-relations-to-the-same-php-class">Using multiple relations to the same PHP class</a></p></li></ul></li><li><p><a href="#identity-mapping">Identity mapping</a></p><ul><li><p><a href="#activate-identity-mapping">Activate identity mapping</a></p></li><li><p><a href="#effects-of-identity-mapping">Effects of identity mapping</a></p></li><li><p><a href="#related-objects">Related objects</a></p></li><li><p><a href="#pre-fetching-of-related-objects">Pre-fetching of related objects</a></p></li><li><p><a href="#related-object-sub-sets">Related object sub-sets</a></p></li></ul></li></ul></div><a name="introduction"></a><a name="id3"></a><h3>Introduction</h3><p>The PersistentObject component provides object persistence for PHP 5 using a database. PersistentObject uses the Database component to provide database abstraction. It does not rely on code generation and does not force a specific inheritance structure to work.</p><p>PersistentObject is built to be fast and flexible, allowing you to build persistent classes in the same way as any other class in your application. It also utilizes the query abstraction layer of the Database component to make it easy to build queries. Please refer to the API documentation of <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcQuerySelect.html'>ezcQuerySelect</a> for detailed examples on how to use the query abstraction layer.</p><p>The PersistentObjectDatabaseSchemaTiein component allows you to automatically generate the definition files needed by PersistentObject from a database schema or the structure of your database. For more information, please refer to the API documentation on <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectSchemaGenerator.html'>ezcPersistentObjectSchemaGenerator</a>.</p><a name="class-overview"></a><a name="id4"></a><h3>Class overview</h3><p>ezcPersistentSession is the main API for interacting with the persistent objects. Loading, saving and deleting persistent objects is done through this class. <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a> can be used to add identity mapping support to it (see <a href="#identity-mapping">Identity mapping</a>).</p><a name="basic-usage"></a><a name="id5"></a><h3>Basic usage</h3><p>This chapter describes the typical usage of PersistentObject with a single persistent class, using MySQL as the persistence storage.</p><a name="the-persistent-class"></a><a name="id6"></a><h4>The persistent class</h4><p>We want to make a simple class, representing a person, persistent using a persistent object. This is a simple class with only a few members:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #0000FF">class&nbsp;</span><span style="color: #000000">Person</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #000000">$id&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #000000">$name&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #000000">$age&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #000000">getState</span><span style="color: #0000FF">()</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$result&nbsp;</span><span style="color: #0000FF">=&nbsp;array();</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$result</span><span style="color: #0000FF">[</span><span style="color: #335533">'id'</span><span style="color: #0000FF">]&nbsp;=&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">id</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$result</span><span style="color: #0000FF">[</span><span style="color: #335533">'name'</span><span style="color: #0000FF">]&nbsp;=&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">name</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$result</span><span style="color: #0000FF">[</span><span style="color: #335533">'age'</span><span style="color: #0000FF">]&nbsp;=&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">age</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">$result</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #000000">setState</span><span style="color: #0000FF">(&nbsp;array&nbsp;</span><span style="color: #000000">$properties&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(&nbsp;</span><span style="color: #000000">$properties&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$key&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;</span><span style="color: #000000">$value&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">$key&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$value</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The id member will map to the required persistent identifier. It has to default to null. This is not required for any of the other mapped members. The id field is a required unique identifier for this persistent object. It is generated by the identifier generator and usually maps to an auto increment column in the database.</p><p>For simplicity, we have made the name and age members of the Person class public. However, this is not required and in a real application you can use any access method you like. You can even make the data completely private.</p><p>All persistent objects must implement the getState() and setState() methods. They are used to retrieve the state of the object when saving it and to set it when loading it. The getState() method should always return the complete state of the object while the setState() method should set only one member at the time.</p><p>The state arrays used by getState() and setState() must be indexed by the property names, as defined in the persistence mapping below. They do not act on the database columns names.</p><a name="the-persistence-mapping"></a><a name="id7"></a><h4>The persistence mapping</h4><p>We are going to map the Person class onto the following SQL table:</p><code class="block">CREATE TABLE persons
(
  id integer unsigned not null auto_increment,
  full_name varchar(255),
  age integer,
  PRIMARY KEY (id)
) TYPE=InnoDB;</code><p>The fields map one to one to the members of the Person class. Using the InnoDB type is not required. We strongly recommend it however, since it supports transactions. The id column is of the type auto_increment. This is required for the id generator that we will use. Other id generators may have other requirements to work as expected.</p><p>In order for PersistentObject to be able to store objects of the Person class into the persons table, we need to tell it how the columns are mapped to class members. We will use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCodeManager.html'>ezcPersistentCodeManager</a> to fetch the definitions when required.</p><p>ezcPersistentCodeManager requires us to define the mapping using the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectDefinition.html'>ezcPersistentObjectDefinition</a>, <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectIdProperty.html'>ezcPersistentObjectIdProperty</a> and <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectProperty.html'>ezcPersistentObjectProperty</a> classes:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$def&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectDefinition.html'>ezcPersistentObjectDefinition</a></span><span style="color: #0000FF">();</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">table&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"persons"</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">class&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"Person"</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectIdProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">columnName&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'id'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">propertyName&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'id'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">generator&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentGeneratorDefinition.html'>ezcPersistentGeneratorDefinition</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentNativeGenerator.html'>ezcPersistentNativeGenerator</a>'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'name'</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'name'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnName&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'full_name'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'name'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyName&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'name'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'name'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyType&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectProperty.html#constPHP_TYPE_STRING'>ezcPersistentObjectProperty::PHP_TYPE_STRING</a></span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'age'</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'age'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnName&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'age'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'age'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyName&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'age'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'age'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyType&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectProperty.html#constPHP_TYPE_INT'>ezcPersistentObjectProperty::PHP_TYPE_INT</a></span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The first block of code creates the definition object and sets the database table and the name of the class to map. The second block defines the mapping of the identifier member and the algorithm that should be used to create identifiers for new objects. We will use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentNativeGenerator.html'>ezcPersistentNativeGenerator</a>, which simply retrieves the new id generated by auto_increment. If you rely on a database backend that does not support auto_increment (e.g. Oracle), <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSequenceGenerator.html'>ezcPersistentSequenceGenerator</a> is the class to choose here.</p><p>The next two code blocks define the mapping between the database columns and the class members. It is possible to use the same name in the class and the database for a field.</p><p>The members must be inserted into the properties member, which is an associative array, using the name of the member as the key name. Note that this must not necessarily be the same name as the database column the property corresponds to. It is required that you use the property name here!</p><p>If you look at the API for <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectDefinition.html'>ezcPersistentObjectDefinition</a>, it also has a property named "columns" that is the same array as the "properties", except that it is mapped to the column names instead of the property names. This reverse mapping is set up by <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCodeManager.html'>ezcPersistentCodeManager</a> automatically.</p><p>Finally, we return the complete definition. Your definition will not work unless you return it to the manager.</p><p>To make the definition work with the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCodeManager.html'>ezcPersistentCodeManager</a>, it must be put in a separate PHP file and given the name of the class in lowercase letters. In our example, the filename should be person.php.</p><p>For classes in namespaces (PHP 5.3 and newer), sub-directories are used for the namespaces. That means, the persistence definition for a class <code class="inline">\My\Namespace\Person</code> must reside in the file <code class="inline">my/namespace/person.php</code>.</p><a name="the-session-object"></a><a name="id8"></a><h4>The session object</h4><p>The session object is in charge of the actual loading and saving of persistent objects. A session can be created by simply instantiating it:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$db&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcDbFactory.html#create'>ezcDbFactory::create</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'mysql://user:password@host/database'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$session&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$db</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCacheManager.html'>ezcPersistentCacheManager</a></span><span style="color: #0000FF">(&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCodeManager.html'>ezcPersistentCodeManager</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"path/to/definitions"&nbsp;</span><span style="color: #0000FF">)&nbsp;)</span></li>
<li><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The session takes two arguments: a pointer to the database instance to use and the manager from which to retrieve persistent object definitions. You can also use a Database instance by using the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcDbInstance.html'>ezcDbInstance</a> class. You can then simply use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcDbInstance.html#get'>ezcDbInstance::get</a>(); instead of passing $db as argument to the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a>'s constructor.</p><p>We are using <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCodeManager.html'>ezcPersistentCodeManager</a> to load the definitions directly from file. You should point it to the location where you saved the person.php file. If you have several directories containing definitions, you can use the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentMultiManager.html'>ezcPersistentMultiManager</a> class to add as many as you like. In addition to the code manager we use a cache manager. The cache manager makes sure the definition is loaded from disk only once.</p><p>While it is possible to create a new session each time you want to manipulate a persistent object, you will probably want to use the same session each time. This functionality can be achieved by using the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionInstance.html'>ezcPersistentSessionInstance</a> class:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$session&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcDbInstance.html#get'>ezcDbInstance::get</a></span><span style="color: #0000FF">(),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCacheManager.html'>ezcPersistentCacheManager</a></span><span style="color: #0000FF">(&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCodeManager.html'>ezcPersistentCodeManager</a></span><span style="color: #0000FF">(&nbsp;...&nbsp;)&nbsp;)&nbsp;);</span></li>
<li><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionInstance.html#set'>ezcPersistentSessionInstance::set</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$session&nbsp;</span><span style="color: #0000FF">);&nbsp;</span><span style="color: #007700">//&nbsp;set&nbsp;default&nbsp;session</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;retrieve&nbsp;the&nbsp;session</span></li>
<li><span style="color: #000000">$session&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionInstance.html#get'>ezcPersistentSessionInstance::get</a></span><span style="color: #0000FF">();</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="lazy-initialization"></a><a name="id9"></a><h4>Lazy initialization</h4><p>Lazy initialization is a mechanism to load and configure a component, only when it is really used in your application. This mechanism saves time for parsing the classes and configuration, when the component is not used at all during one request. You can find a description how you can use it for your own components and how it works in the <a href="../Base/tutorial.html#lazy-initialization">ezcBase tutorial</a>. The keyword for the database component is <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcInitPersistentSessionInstance.html'>ezcInitPersistentSessionInstance</a>.</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #0000FF">require_once&nbsp;</span><span style="color: #335533">'tutorial_autoload.php'</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #0000FF">class&nbsp;</span><span style="color: #000000">customLazyPersistentSessionConfiguration&nbsp;</span><span style="color: #0000FF">implements&nbsp;</span><span style="color: #000000">ezcBaseConfigurationInitializer</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #000000">configureObject</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$instance&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(&nbsp;</span><span style="color: #000000">$instance&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">:&nbsp;</span><span style="color: #007700">//&nbsp;Default&nbsp;instance</span></li>
<li><span style="color: #007700">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$session&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcDbInstance.html#get'>ezcDbInstance::get</a></span><span style="color: #0000FF">(),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCodeManager.html'>ezcPersistentCodeManager</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'../persistent'&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #335533">'second'</span><span style="color: #0000FF">:</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$session&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcDbInstance.html#get'>ezcDbInstance::get</a></span><span style="color: #0000FF">(),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentCodeManager.html'>ezcPersistentCodeManager</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'../additionalPersistent'&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li><span style="color: #0000FF">}</span></li>
<li></li>
<li><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcBaseInit.html#setCallback'>ezcBaseInit::setCallback</a></span><span style="color: #0000FF">(&nbsp;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcInitPersistentSessionInstance.html'>ezcInitPersistentSessionInstance</a>'</span><span style="color: #0000FF">,&nbsp;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'customLazyPersistentSessionConfiguration'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;Create&nbsp;and&nbsp;configure&nbsp;default&nbsp;persistent&nbsp;session</span></li>
<li><span style="color: #000000">$db&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionInstance.html#get'>ezcPersistentSessionInstance::get</a></span><span style="color: #0000FF">();</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;Create&nbsp;and&nbsp;configure&nbsp;additional&nbsp;persistent&nbsp;session</span></li>
<li><span style="color: #000000">$sb&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionInstance.html#get'>ezcPersistentSessionInstance::get</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'second'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">?&gt;</span></li>

</ol><p>ezcBaseInit::setCallback accepts as a first parameter a component specific key, which lets the component later request the right configuration callback. The second parameter is the name of the class to perform the static callback on. This class must implement the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcBaseConfigurationInitializer.html'>ezcBaseConfigurationInitializer</a> class. Each component's lazy initialization calls the static method configureObject() on the referenced class.</p><p>This example shows a way to configure multiple database handlers, only when they are really requested in your application. The example does basically the same like the first example in this tutorial, but creates the connection not before it is really required.</p><p>In line 32 the default persistent session is first requested in this example, which does not exist yet, so that the configuration class earlier referenced through the setCallback() call will be asked for a new instance for the current instance name, which is 'null' for the default instance.</p><p>In the configureObject() method in line 8 we switch on the instance name and create and return the right newly created database handler. Line 35 shows, that this will also work with multiple database instances, creating an additional persistent session that reads the definition files from another directory (additionalPersistent).</p><a name="creating-and-updating-an-object"></a><a name="id10"></a><h4>Creating and updating an object</h4><p>Creating a new Person object and making it persistent is straightforward:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000">Person</span><span style="color: #0000FF">();</span></li>
<li><span style="color: #000000">$object</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">name&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"Guybrush&nbsp;Threepwood"</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$object</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">age&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">31</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">save</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>This code saves our newly created object to the database and generates an id for it. The id is set to the id property of the object. Since Guybrush is our first person, he is assigned the id of 1.</p><p>Of course, the age of Guybrush Threepwood is the source of much debate, and he is probably younger than 31. To change his age, simply edit the object and tell the session to update it.</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$object</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">age&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">25</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">update</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>Note that we used update() to store the object this time. This is because we want to trigger an UPDATE query instead of an INSERT query.</p><a name="finding-objects"></a><a name="id11"></a><h4>Finding objects</h4><p>There are several ways to retrieve persistent objects from the database. The simplest is to fetch one object by its identifier.</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">1&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>This code retrieves the Guybrush object created above.</p><p>If you have stored a lot of persistent objects to the database and want to retrieve a list, you can use the find() method. The find() method requires a query parameter that can first be retrieved from the session.</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$q&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">createFindQuery</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">where</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">gt</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'age'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">bindValue</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">15&nbsp;</span><span style="color: #0000FF">)&nbsp;)&nbsp;)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #000000">orderBy</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'full_name'&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #000000">limit</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">10&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$objects&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">find</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">'Person'&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>This code will fetch a maximum of 10 Person objects where the age is higher than 15, sorted by name.</p><p>This is achieved by manipulating the query object returned by <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#createFindQuery'>ezcPersistentSession-&gt;createFindQuery</a>(). To learn more about query abstraction and how to use it, please refer to the <a href="introduction_Database.html#query-abstraction-usage">specific subsection of the Database components tutorial</a>.</p><p>The find() method will fetch the complete result set and instantiate it for you. This is not desirable if you are fetching large numbers of objects and you want it to be fast and efficient. For this you can use the findIterator() method:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$q&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">createFindQuery</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">where</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">gt</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'age'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">bindValue</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">15&nbsp;</span><span style="color: #0000FF">)&nbsp;)&nbsp;)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;-&gt;</span><span style="color: #000000">orderBy</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'name'&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;-&gt;</span><span style="color: #000000">limit</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">10&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$objects&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">findIterator</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">'Person'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">foreach(&nbsp;</span><span style="color: #000000">$objects&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">//&nbsp;...</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>This code will produce the same result as the first find() example. However, only one object will be instantiated and the data will be transferred from the database only when it is needed.</p><p>The final example uses a find query with a logical and to find objects:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$q&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">createFindQuery</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">where</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">lAnd</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">eq</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'name'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">bindValue</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Guybrush&nbsp;Threepwood'&nbsp;</span><span style="color: #0000FF">)&nbsp;),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">eq</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'age'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">bindValue</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">25&nbsp;</span><span style="color: #0000FF">)&nbsp;)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$objects&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">findIterator</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">'Person'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">foreach(&nbsp;</span><span style="color: #000000">$objects&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">//&nbsp;...</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="deleting-objects"></a><a name="id12"></a><h4>Deleting objects</h4><p>The easiest way to delete persistent objects is to use the delete() method on the session:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">1&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">delete</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>Of course, you can only delete instantiated objects this way. If you want to delete an object or a whole series of objects that are not instantiated, you can use the deleteFromQuery() method:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$q&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">createDeleteQuery</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">where</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">gt</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'age'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$q</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">bindValue</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">15&nbsp;</span><span style="color: #0000FF">)&nbsp;)&nbsp;);</span></li>
<li><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">deleteFromQuery</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$q&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The above code will remove all persons from the database who are more than 15 years old.</p><a name="identifier-generation"></a><a name="id13"></a><h3>Identifier generation</h3><p>All persistent objects must have an identifier field. The identifier generation algorithm defines how the system will generate ids for new objects. This chapter describes the available generators.</p><a name="ezcpersistentsequencegenerator"></a><a name="id14"></a><h4>ezcPersistentSequenceGenerator</h4><p>The sequence generator relies on the PDO::lastInsertId() method to retrieve the ids for newly created persistent objects.</p><p>For databases supporting auto_increment (like MySQL and SQLite), use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentNativeGenerator.html'>ezcPersistentNativeGenerator</a>. Other databases must use a sequence. For example, the PostgreSQL person table definition should be as follows:</p><code class="block">CREATE TABLE persons
(
  id integer unsigned not null,
  full_name varchar(255),
  age integer,
  PRIMARY KEY (id)
);
CREATE SEQUENCE person_seq START 1;</code><p>If your database requires you to use a sequence, this parameter should be provided to <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSequenceGenerator.html'>ezcPersistentSequenceGenerator</a> in the mapping definition.</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">generator&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentGeneratorDefinition.html'>ezcPersistentGeneratorDefinition</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSequenceGenerator.html'>ezcPersistentSequenceGenerator</a>'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;array(&nbsp;</span><span style="color: #335533">'sequence'&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;</span><span style="color: #335533">'person_sequence'&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="ezcpersistentnativegenerator"></a><a name="id15"></a><h4>ezcPersistentNativeGenerator</h4><p>The native generator relies on auto_increment, which is supported by, among others, MySQL and SQLite. An example table definition looks like this:</p><code class="block">CREATE TABLE persons
(
    id integer unsigned not null auto_increment,
    full_name varchar(255),
    age integer,
    PRIMARY KEY (id)
);</code><p>The corresponding generator definition is below:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">generator&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentGeneratorDefinition.html'>ezcPersistentGeneratorDefinition</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentNativeGenerator.html'>ezcPersistentNativeGenerator</a>'</span></li>
<li><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="ezcpersistentmanualgenerator"></a><a name="id16"></a><h4>ezcPersistentManualGenerator</h4><p>If you do not rely on a database mechanism to generate values for a primary key column, you have to use the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManualGenerator.html'>ezcPersistentManualGenerator</a> class. You can then set the value of the id property by hand and save the object afterwards.</p><p>For example:</p><code class="block">CREATE TABLE persons
(
    login varchar(25),
    full_name varchar(255),
    age integer,
    PRIMARY KEY (login)
);</code><p>In this table, the string value is used as the primary key. Therefore, we have to generate id values manually. Use the following definition:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">generator&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentGeneratorDefinition.html'>ezcPersistentGeneratorDefinition</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManualGenerator.html'>ezcPersistentManualGenerator</a>'</span></li>
<li><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>For saving a new instance, use the following code:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000">Person</span><span style="color: #0000FF">();</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;Manually&nbsp;set&nbsp;the&nbsp;id</span></li>
<li><span style="color: #000000">$object</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">login&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"guybrush"</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$object</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">name&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"Guybrush&nbsp;Threepwood"</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$object</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">age&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">31</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">save</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$object&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="definition-loaders"></a><a name="id17"></a><h3>Definition loaders</h3><p>The session object needs to be able to fetch the persistent object definitions in order to function properly. The task of fetching the definitions is performed by a definition loader, which is provided to the session when it is instantiated.</p><a name="ezcpersistentcodemanager"></a><a name="id18"></a><h4>ezcPersistentCodeManager</h4><p>This is currently the only manager available. It simply reads the definition from a file with the same name as the class from the specified directory. It does not perform any error checking on the definition and simply assumes that it is correct.</p><a name="extending-the-definition-loader"></a><a name="id19"></a><h4>Extending the definition loader</h4><p>It is very easy to create your own definition loader. Simply extend the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentDefinitionManager.html'>ezcPersistentDefinitionManager</a> abstract class and implement the fetchDefinition() method:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #0000FF">class&nbsp;</span><span style="color: #000000">ezcPersistentCodeManager&nbsp;</span><span style="color: #0000FF">extends&nbsp;</span><span style="color: #000000">ezcPersistentDefinitionManager</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #000000">fetchDefinition</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$class&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The fetchDefinition() method should create the definition structure for the requested class or throw an exception.</p><a name="relations"></a><a name="id20"></a><h3>Relations</h3><p>Relations are defined within the persistence mapping.</p><a name="relation-class-overview"></a><a name="id21"></a><h4>Relation class overview</h4><p>The following definition classes are available to realize object relations:</p><dl><dt>ezcPersistentOneToManyRelation</dt><dd>This class is used to define 1:n relations. For example, one person might be related to multiple addresses, but one address might only be related to one person.</dd><dt>ezcPersistentManyToManyRelation</dt><dd>Using this class, you can define n:m relations. For example, a person can be related to multiple addresses, while an address can be related to multiple persons.</dd><dt>ezcPersistentOneToOneRelation</dt><dd>With this class you can define 1:1 relations, which might be useful for slight de-normalization. For example, you can split your user data from the user credentials.</dd><dt>ezcPersistentManyToOneRelation</dt><dd>This relation (n:1) does not make sense on its own, but as the reverse connection for a 1:n relation.</dd><dt>ezcPersistentRelationCollection</dt><dd>This class allows you to define multiple relations to the same PHP class.</dd></dl><p>All of these classes extend the abstract class <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelation.html'>ezcPersistentRelation</a>.</p><a name="relations-basics"></a><a name="id22"></a><h4>Relations basics</h4><p>For the examples in this section, we will reuse the Person class, defined in <a href="#the-persistent-class">The persistent class</a>. In addition, we will use an Address class, which looks as follows:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #0000FF">class&nbsp;</span><span style="color: #000000">Address</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #000000">$id&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #000000">$street&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #000000">$zip&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #000000">$city&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #000000">setState</span><span style="color: #0000FF">(&nbsp;array&nbsp;</span><span style="color: #000000">$state&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(&nbsp;</span><span style="color: #000000">$state&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$key&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;</span><span style="color: #000000">$value&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">$key&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$value</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #000000">getState</span><span style="color: #0000FF">()</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"id"&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">id</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"street"&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">street</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"zip"&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">zip</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"city"&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">city</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The Address class will be extended later on to include relations. The following basic persistence mapping is used and extended for each example:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$def&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectDefinition.html'>ezcPersistentObjectDefinition</a></span><span style="color: #0000FF">();</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">table&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"addresses"</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">class&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectIdProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">columnName&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'id'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">propertyName&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'id'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">generator&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentGeneratorDefinition.html'>ezcPersistentGeneratorDefinition</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSequenceGenerator.html'>ezcPersistentSequenceGenerator</a>'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'street'</span><span style="color: #0000FF">]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'street'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'street'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'street'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyName&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'street'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'street'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyType&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectProperty.html#constPHP_TYPE_STRING'>ezcPersistentObjectProperty::PHP_TYPE_STRING</a></span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'zip'</span><span style="color: #0000FF">]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'zip'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'zip'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'zip'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyName&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'zip'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'zip'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyType&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectProperty.html#constPHP_TYPE_STRING'>ezcPersistentObjectProperty::PHP_TYPE_STRING</a></span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'city'</span><span style="color: #0000FF">]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'city'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'city'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'city'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyName&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'city'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'city'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyType&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectProperty.html#constPHP_TYPE_STRING'>ezcPersistentObjectProperty::PHP_TYPE_STRING</a></span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="defining-a-simple-relation"></a><a name="id23"></a><h4>Defining a simple relation</h4><p>The following extensions are necessary for the given class and persistence mapping, to realize a simple 1:n relation. Each person will be able to have multiple addresses, but one address may only refer to one person.</p><p>The Address class needs to be enhanced as follows, to store the id of the Person it is related to.</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #0000FF">class&nbsp;</span><span style="color: #000000">Address</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #007700">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">private&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #007700">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">public&nbsp;function&nbsp;</span><span style="color: #000000">getState</span><span style="color: #0000FF">()</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">//&nbsp;...</span></li>
<li><span style="color: #007700">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"person"&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>Additionally, we need to define the new property $person in the persistence mapping of the Address class:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'person'</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'person'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnName&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'person_id'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'person'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyName&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'person'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">properties</span><span style="color: #0000FF">[</span><span style="color: #335533">'person'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">propertyType&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectProperty.html#constPHP_TYPE_INT'>ezcPersistentObjectProperty::PHP_TYPE_INT</a></span><span style="color: #0000FF">;</span></li>
<li></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The relation definition takes place in the persistence mapping of the Person class in <a href="#the-persistent-class">The persistent class</a>. It needs to be extended as follows:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentOneToManyRelation.html'>ezcPersistentOneToManyRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"addresses"</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"id"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"person_id"</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;..</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>A relation to another persistent object is defined in the property <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectDefinition.html'>ezcPersistentObjectDefinition</a> $relations, which is an array. Each relation must have the name of the persistent object class it refers to as the key in this array. An instance of one of the classes shown in <a href="#class-overview">Class overview</a> must be the value. In this case, it is <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentOneToManyRelation.html'>ezcPersistentOneToManyRelation</a>. The parameter to its constructor are the names of the tables that the relation refers to. The first table is the table of the current object, and the second one refers to the related object.</p><p>To define which properties are used to realize the relation mapping, the property <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentOneToManyRelation.html'>ezcPersistentOneToManyRelation</a>-&gt;columnMap is used. It contains an array of (in this case) <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a>, which maps one column of each of the tables to one column of another. In the above case, the database column "id" from the table "persons" would be mapped to the column "person_id" in the table "addresses". In general, this means, that "id" is the primary key from the "persons" table and "person_id" is the foreign key in the "addresses" table, that refers to the "persons" table. Please note that the relation mappings are done on the table name/column name and not on the class name/property name.</p><p>If you want to map using several columns, you can add more <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a> instances to the columnMap array. For example, if you are using a person's first and last name as the primary key for the "persons" table, you could define the relation like this:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentOneToManyRelation.html'>ezcPersistentOneToManyRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"addresses"</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"firstname"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"person_firstname"</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"lastname"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"person_lastname"</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="using-a-relation"></a><a name="id24"></a><h4>Using a relation</h4><p>To use the previously defined 1:n relation, <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a> offers several new methods:</p><dl><dt><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#getRelatedObject'>ezcPersistentSession-&gt;getRelatedObject</a>()</dt><dd>This method can be used to retrieve a single related object to a given source object. If no related object can be found, it will throw an exception.</dd><dt><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#getRelatedObjects'>ezcPersistentSession-&gt;getRelatedObjects</a>()</dt><dd>In contrast to <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#getRelatedObject'>ezcPersistentSession-&gt;getRelatedObject</a>(), this method always returns an array of all related objects. It will not throw an exception if no related object can be found, but will instead return an empty array.</dd><dt><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#addRelatedObject'>ezcPersistentSession-&gt;addRelatedObject</a>()</dt><dd>Using this method, you can build a relation between two persistent objects. It will set the defined properties on the objects, but does not store them to the database automatically. (Exceptions are <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a> objects. Further details are below.)</dd><dt><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#removeRelatedObject'>ezcPersistentSession-&gt;removeRelatedObject</a>()</dt><dd>As the counterpart to <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#addRelatedObject'>ezcPersistentSession-&gt;addRelatedObject</a>(), this method is used to remove the relation between two objects. It will not store the given objects for you, but only remove the necessary properties. (Again, exceptions are <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a> objects. Further details are below.)</dd></dl><p>Using these methods, we can now retrieve all addresses that are related to one person:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"Person"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">1&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"Address"&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The variable $addresses will then contain an array of all Address objects found for the Person object with an id of 1. To relate these addresses to another Person object, we can do the following:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$personOld&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"Person"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">1&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$personNew&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"Person"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">23&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$personOld</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"Address"&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">foreach&nbsp;(&nbsp;</span><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$address&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">removeRelatedObject</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$personOld</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$address&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">addRelatedObject</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$personNew</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$address&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">update</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$address&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="defining-n-m-relations"></a><a name="id25"></a><h4>Defining n:m relations</h4><p>The <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a> class works slightly different than the other <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelation.html'>ezcPersistentRelation</a> classes. For this kind of relation, you need an extra table in your database to store the relation records. The next example shows the definition of an <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a> relation, based on the Person and Address example classes. Each person can have several addresses and each address can be used by several persons. You need to use the original example classes for this, thus we do not need to extend them here. The definition of the relational mapping for the Person class must be extended as follows:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"addresses"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons_addresses"</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentDoubleTableMap.html'>ezcPersistentDoubleTableMap</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"person_id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"address_id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"id"&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>In contrast to all other implementations of <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelation.html'>ezcPersistentRelation</a>, the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a> constructor expects three table names:</p><ul><li><p>the name of the current objects table</p></li><li><p>the name of the related objects table</p></li><li><p>the table name to store the relation records</p></li></ul><p>A similar exception applies to columnMap of this relation definition. It consists of <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentDoubleTableMap.html'>ezcPersistentDoubleTableMap</a> instances, which carry four column names each. The first column is the column to choose from the source table (usually its primary key). The second column defines the column in your relation table that maps to the first column. In our example, the column "id" from the "persons" table maps to the column "person_id" from the relation table "persons_addresses". The same applies to the third and fourth columns. The third column defines the column of the relation table that maps to the fourth column given. The fourth column specifies the column of your destination table to use for mapping. In our example, the relation table "persons_addresses" has a column "address_id", which is a foreign key referring to the column "id" in the table "addresses".</p><p>As with <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a> instances, you can use multiple mappings in one <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a>-&gt;columnMap array. Here, we use a person's first and last name for the mapping:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"addresses"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons_addresses"</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentDoubleTableMap.html'>ezcPersistentDoubleTableMap</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"firstname"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"person_firstname"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"address_id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"id"&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentDoubleTableMap.html'>ezcPersistentDoubleTableMap</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"lastname"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"person_lastname"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"address_id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"id"&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="using-n-m-relations"></a><a name="id26"></a><h4>Using n:m relations</h4><p>As stated earlier, the usage methods behave slightly differently when dealing with n:m relations. If you use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#addRelatedObject'>ezcPersistentSession-&gt;addRelatedObject</a>(), the desired relation record is inserted into the relation table. The same applies to the removeRelatedObject() method of <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a>, which deletes the specific record. This also means that you do not need to store the affected objects explicitly after altering the relations between them. If you have made other changes to the objects, they must be stored to save the changes.</p><p>Aside from that, the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#delete'>ezcPersistentSession-&gt;delete</a>() method keeps track of the relation records. If you delete a record, all of its relation records are automatically deleted.</p><a name="special-1-1-relations"></a><a name="id27"></a><h4>Special 1:1 relations</h4><p>If you want to use 1:1 relations, where two tables share a common primary key, you need to define a table to generate the key and the other table to use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManualGenerator.html'>ezcPersistentManualGenerator</a>. For our example, if one person may only have one address, the definition would be as follows:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$def&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectDefinition.html'>ezcPersistentObjectDefinition</a></span><span style="color: #0000FF">();</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">table&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"addresses"</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">class&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000">ezcPersistentObjectIdProperty</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">columnName&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'id'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">propertyName&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'id'</span><span style="color: #0000FF">;</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">idProperty</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">generator&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentGeneratorDefinition.html'>ezcPersistentGeneratorDefinition</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManualGenerator.html'>ezcPersistentManualGenerator</a>'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>This is the relation (defined in the definition file of the Person):</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentOneToOneRelation.html'>ezcPersistentOneToOneRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"addresses"</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"id"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"person_id"</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>If you let both tables use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSequenceGenerator.html'>ezcPersistentSequenceGenerator</a> for the same key, <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a> will fail to save a related object, since the id will already be set by the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#addRelatedObject'>ezcPersistentSession::addRelatedObject</a>() method.</p><p>Another way to make this work is to not use the same primary key for both tables, but to make the Address object have its own id and only use the Person id as a foreign key.</p><a name="reverse-relations"></a><a name="id28"></a><h4>Reverse relations</h4><p>Since you can always look at a relation from two sides, <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelation.html'>ezcPersistentRelation</a> implementations can be configured to be "reverse". A reverse relation indicates that the relation is already defined in the opposite direction and that the original direction is the main used one. The one marked as "reverse" is a secondary one, for consistency reasons. For a relation that is marked as reverse, it is not possible to use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#addRelatedObject'>ezcPersistentSession-&gt;addRelatedObject</a>() and <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#removeRelatedObject'>ezcPersistentSession-&gt;removeRelatedObject</a>(). You can still use <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#getRelatedObjects'>ezcPersistentSession-&gt;getRelatedObjects</a>() for relations that are flagged "reverse".</p><p>For most relation types, the reverse attribute of the relation definition object is set to false by default. You can manually set it. Exceptions are <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToOneRelation.html'>ezcPersistentManyToOneRelation</a> relations. This relation type only makes sense as a reverse relation for <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentOneToManyRelation.html'>ezcPersistentOneToManyRelation</a>. Therefore, the reverse attribute is set to true for <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToOneRelation.html'>ezcPersistentManyToOneRelation</a> and is not publicly accessible for writing.</p><p>The following example shows the reverse relation definition for the n:m relations example:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Person"</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"addresses"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons_addresses"</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentDoubleTableMap.html'>ezcPersistentDoubleTableMap</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"address_id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"person_id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"id"&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">reverse&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">true</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>With the relation definition shown above, you would still be able to relate the Persons object to an Address object, but not to add or remove related Person objects to/from an Address. In other words, the following code still works:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$address&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">23&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$persons&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$address</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"Person"&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>While the following would not work:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li><span style="color: #0000FF">foreach&nbsp;(&nbsp;</span><span style="color: #000000">$persons&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">removeRelatedObject</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$address</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>Instead, only the other direction works, because this one is the main direction.</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li><span style="color: #0000FF">foreach&nbsp;(&nbsp;</span><span style="color: #000000">$persons&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">removeRelatedObject</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">$address&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">}</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="cascading-deletes"></a><a name="id29"></a><h4>Cascading deletes</h4><p>Cascading relations are done through the flag "cascade" of a <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelation.html'>ezcPersistentRelation</a> implementation. All implementations except the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a> class support this flag. It allows you to automatically delete all related objects for a source object when the source object is deleted.</p><p>The following example shows how to add a cascading relation to a relation definition, based on the example from <a href="#defining-a-simple-relation">Defining a simple relation</a>:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentOneToManyRelation.html'>ezcPersistentOneToManyRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"persons"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"addresses"</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"id"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"person_id"</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">"Address"</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">cascade&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">true</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #0000FF">return&nbsp;</span><span style="color: #000000">$def</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>If you now use the following, the Person object and all related Address objects are deleted:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"Person"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">1&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">delete</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>Beware that this does not work with <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a> instances, because it could cause serious inconsistencies in your data.</p><a name="defining-multiple-relations-to-the-same-php-class"></a><a name="id30"></a><h4>Defining multiple relations to the same PHP class</h4><p>In some cases it might be necessary to define multiple relations to the same PHP class. An example for this can be seen when enhancing the Person example from <a href="#the-persistence-mapping">The persistence mapping</a>  as follows:</p><code class="block">CREATE TABLE persons
(
  id integer unsigned not null auto_increment,
  full_name varchar(255),
  age integer,
  mother integer,
  father integer,
  PRIMARY KEY (id)
)</code><p>Here each person is connected to 2 objects of the same table: The mother and the father. Since only 1 PHP class per table is desired, the class needs to be referenced by the Person class twice.</p><p>Assuming that the 2 new properties of the Person class have been defined correctly in the persistence mapping, the following code can be used to achieve the desired relations:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;$def&nbsp;is&nbsp;the&nbsp;persistence&nbsp;defintion</span></li>
<li></li>
<li><span style="color: #000000">$relations&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationCollection.html'>ezcPersistentRelationCollection</a></span><span style="color: #0000FF">();</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;Mother&nbsp;relation</span></li>
<li></li>
<li><span style="color: #000000">$relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'mothers_children'</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentOneToManyRelation.html'>ezcPersistentOneToManyRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'PO_person'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'PO_person'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'mothers_children'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'id'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">'mother'&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'mothers_children'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">cascade&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">true</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'mother'</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToOneRelation.html'>ezcPersistentManyToOneRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'PO_person'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'PO_person'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'mother'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSingleTableMap.html'>ezcPersistentSingleTableMap</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'mother'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">'id'&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;..</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">]&nbsp;=&nbsp;</span><span style="color: #000000">$relations</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>2 relations need to be defined to reflect the relation between a mother an her children. "mother" defines the relation from a child to its mother and "mothers_children" defines the opposite direction, from a child to its mother. Both relations operate on the Person class itself, therefore an <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationCollection.html'>ezcPersistentRelationCollection</a> is used to carry the relation definitions.</p><p>Relations are defined as shown earlier in this section. The only difference here is, that the relation definitions themselves are not added directly to the $relations property of the <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentObjectDefinition.html'>ezcPersistentObjectDefinition</a> instance. Instead they are assigned to unique names on a relation collection, which is then added to the $relations property of the object definition.</p><p>The comment indicating further code (...) in the example above indicates that further relations are missing in the collection: The relations "father" and "fathers_children" are excluded here, since they work exactly like the corresponding mother relations, above. A fifth relation is shown below:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$relations&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationCollection.html'>ezcPersistentRelationCollection</a></span><span style="color: #0000FF">();</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;mother&nbsp;/&nbsp;father&nbsp;relations</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;Sibling&nbsp;relation</span></li>
<li></li>
<li><span style="color: #000000">$relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'siblings'</span><span style="color: #0000FF">]&nbsp;=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentManyToManyRelation.html'>ezcPersistentManyToManyRelation</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"PO_person"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"PO_person"</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">"PO_sibling"</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'siblings'</span><span style="color: #0000FF">]-&gt;</span><span style="color: #000000">columnMap&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentDoubleTableMap.html'>ezcPersistentDoubleTableMap</a></span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">"id"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"person"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"sibling"</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #335533">"id"&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'MultiRelationTestPerson'</span><span style="color: #0000FF">]&nbsp;=&nbsp;</span><span style="color: #000000">$relations</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;assigning&nbsp;the&nbsp;relation&nbsp;collection</span></li>
<li></li>
<li><span style="color: #000000">$def</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">relations</span><span style="color: #0000FF">[</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">]&nbsp;=&nbsp;</span><span style="color: #000000">$relations</span><span style="color: #0000FF">;</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>As can be seen above, a relation collection can carry an arbitrary number of relations, which are of arbitrary type.</p><a name="using-multiple-relations-to-the-same-php-class"></a><a name="id31"></a><h4>Using multiple relations to the same PHP class</h4><p>To make use of the relations to the Person class defined in the last section, the name of the desired relation has to be submitted to all relation operations:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$mother&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">1&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$children&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$mother</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'mothers_children'</span></li>
<li><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The code above fetches all children of a mother, as defined by the relation "mothers_children". The third parameter to <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#getRelatedObject'>ezcPersistentSession-&gt;getRelatedObject</a>() is mandatory in this case. If you leave it out, a <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentUndeterministicRelationException.html'>ezcPersistentUndeterministicRelationException</a> will be thrown. The parameter is ignored if you submit it when not working with a relation collection.</p><p>In the same manor a new related object can only be added if the affected relation is submitted to <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html#addRelatedObject'>ezcPersistentSession-&gt;addRelatedObject</a>() as shown below:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #000000">$newChild&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000">Person</span><span style="color: #0000FF">();</span></li>
<li><span style="color: #000000">$newChild</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">name&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">"New&nbsp;child"</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">save</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$newChild&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">addRelatedObject</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$mother</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$newChild</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'mothers_children'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;Make&nbsp;relation&nbsp;changes&nbsp;take&nbsp;effect</span></li>
<li><span style="color: #000000">$this</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">session</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">save</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$newChild&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><a name="identity-mapping"></a><a name="id32"></a><h3>Identity mapping</h3><p>The <a href="http://martinfowler.com/eaaCatalog/identityMap.html">identity map pattern</a>, as described by Martin Fowler, ensures that only 1 PHP object with the same identity exists. That means, if you load an object from the database a second time, the originally created instance is re-used instead of creating a new instance. In addition to that, identity mapping can potentially save SQL queries and therefore reduce database load.</p><p>Note that with identity mapping, the methods <em>updateFromQuery()</em> and <em>deleteFromQuery()</em> will result in a complete reset of the identity map. Further details on that can be found under <a href="#effects-of-identity-mapping">Effects of identity mapping</a>.</p><a name="activate-identity-mapping"></a><a name="id33"></a><h4>Activate identity mapping</h4><p>Identity mapping is activated by wrapping an instance of <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a> around your existing <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a>:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$originalSession&nbsp;contains&nbsp;a&nbsp;valid&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a></span></li>
<li></li>
<li><span style="color: #000000">$identityMap&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentBasicIdentityMap.html'>ezcPersistentBasicIdentityMap</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$originalSession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">definitionManager</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$session&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$originalSession</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$identityMap</span></li>
<li><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>You can transparently exchange <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a> and <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a> inside your application, since their APIs do not differ.</p><p>One point where you might experience problems are <em>instanceof</em> checks for <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a>. Just replace these with checks for <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionFoundation.html'>ezcPersistentSessionFoundation</a>.</p><a name="effects-of-identity-mapping"></a><a name="id34"></a><h4>Effects of identity mapping</h4><p>Identity mapping avoids that you have 2 different PHP objects with the same database identity in your application. For example:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$identitySession&nbsp;is&nbsp;an&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span></li>
<li></li>
<li><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">23&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;somewhere&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$samePerson&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">23&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The variables <em>$person</em> and <em>$samePerson</em> are both references to the very same object. In fact, the second call to <em>$identitySession-&gt;load()</em> does not issue a database query at all, but just returns the existing instance of the desired <em>Person</em> object, since this has already been loaded before.</p><p>Identity mapping also affects finding of persistent objects:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$identitySession&nbsp;is&nbsp;an&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span></li>
<li></li>
<li><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">23&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$person</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">name&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #335533">'New&nbsp;Name'</span><span style="color: #0000FF">;</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;somewhere&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$query&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">createFindQuery</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$persons&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">find</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$query&nbsp;</span><span style="color: #0000FF">);</span></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The call to <em>$identitySession-&gt;find()</em> fetches all <em>Person</em> objects from the database. This includes the <em>Person</em> with ID 23, which has already been loaded before. Due to that, there is not a second instance of this object in <em>$persons</em>, but the existing instance is re-used. This does not save you an SQL query, but avoids inconsistencies. The change of the <em>$name</em> property of the <em>Person</em> object with ID 23 is reflected in the found objects, although the object has not been saved, yet.</p><p><strong>Note:</strong> You should not use the methods <em>updateFromQuery()</em> and <em>deleteFromQuery()</em> with <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a>. If you use any of these methods, all cached objects will automatically be removed from the identity map, because the effects of these methods can not be traced by the mechanism. The reset of the identity map might result in unexpected inconsistencies, which should originally be avoided by the mechanism.</p><a name="related-objects"></a><a name="id35"></a><h4>Related objects</h4><p>Identity mapping also affects the loading of related objects:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$identitySession&nbsp;is&nbsp;an&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span></li>
<li></li>
<li><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">23&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;somewhere&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$sameAddresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The variable <em>$sameAddresses</em> contains the very same array of <em>Address</em> objects as <em>$addresses</em>. In fact, no second database call is issued, to fetch the related objects, since they have already been loaded before.</p><p>This also works, if you add or delete related objects:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$identitySession&nbsp;is&nbsp;an&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span></li>
<li></li>
<li><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">23&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;Add&nbsp;a&nbsp;new&nbsp;address</span></li>
<li><span style="color: #000000">$newAddress&nbsp;</span><span style="color: #0000FF">=&nbsp;new&nbsp;</span><span style="color: #000000">Address</span><span style="color: #0000FF">();</span></li>
<li><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">addRelatedObject</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$newAddress</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;Remove&nbsp;an&nbsp;address</span></li>
<li><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">removeRelatedObject</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$addresses</span><span style="color: #0000FF">[</span><span style="color: #000000">42</span><span style="color: #0000FF">]</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;somewhere&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$sameAddresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<span style="color: #000000">?&gt;</span>
</ol><p>There is no additional database query performed on the second call to <em>$identitySession-&gt;getRelatedObjects()</em> here, too. Still, the <em>$sameAddresses</em> reflects the operations of adding a new <em>Address</em> to and removing the <em>Address</em> with ID <em>42</em> from the list of related objects. Even if these operations have not been reflected in the database, yet.</p><a name="pre-fetching-of-related-objects"></a><a name="id36"></a><h4>Pre-fetching of related objects</h4><p>Using the identity map decorator allows you to pre-fetch related objects, using a JOIN. There are 2 different methods that <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a> has in addition to <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a>. The first one allows you to load a certain object together with related objects:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$identitySession&nbsp;is&nbsp;an&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span></li>
<li></li>
<li><span style="color: #000000">$prefetchRelations&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'addresses'&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationFindDefinition.html'>ezcPersistentRelationFindDefinition</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'cities'&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationFindDefinition.html'>ezcPersistentRelationFindDefinition</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'City'</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'purchases'&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationFindDefinition.html'>ezcPersistentRelationFindDefinition</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Purchase'</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">loadWithRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">23</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$prefetchRelations</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;somewhere&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">foreach&nbsp;(&nbsp;</span><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$address&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$city&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$address</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'City'</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">}</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;somewhere&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$purchases&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Purchase'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<span style="color: #000000">?&gt;</span>
</ol><p>The method <em>$idSession-&gt;loadWithRelatedObjects()</em> allows you to load a certain object and its related objects (included nesting).</p><p>The array <em>$prefetchRelations</em> defines, which related objects are fetched. The first <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationFindDefinition.html'>ezcPersistentRelationFindDefinition</a> in the array instructs to load related objects of type <em>Address</em>. The second parameter to the constructor of <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationFindDefinition.html'>ezcPersistentRelationFindDefinition</a> can be used to specify the relation name, if you use multiple relations to the same PHP class. The third parameter is used to define deeper relations. In the example above, it defines that for each loaded <em>Address</em> object, the related object of class <em>City</em> is loaded.</p><p>The second element of the <em>$prefetchRelations</em> array defines that for the object to load, also all related objects of the <em>Purchase</em> class are loaded. This loading happens in a single SQL statement, using multiple JOIN statements.</p><p>After defining the relations to fetch, the <em>Person</em> with ID <em>23</em> is loaded, including the defined related objects. Therefore, none of the latter calls to <em>$idSession-&gt;getRelatedObjects()</em> results in a database query, since all of these related object sets have already been loaded in a single SQL query.</p><p>In a similar way, you can find a set of objects including their related objects. Assume that <em>$prefetchRelations</em> is defined in the same way as in the last example:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$identitySession&nbsp;is&nbsp;an&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;$prefetchRelations&nbsp;=&nbsp;array(&nbsp;...&nbsp;);</span></li>
<li></li>
<li><span style="color: #000000">$query&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">createFindQueryWithRelations</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$prefetchRelations</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$persons&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">find</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$query&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;somewhere&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #0000FF">foreach&nbsp;(&nbsp;</span><span style="color: #000000">$persons&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(&nbsp;</span><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$address&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$city&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$address</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'City'</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;}</span></li>
<li></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$purchases&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjects</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Purchase'</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">}</span></li>
<li></li>
<span style="color: #000000">?&gt;</span>
</ol><p>In this case, all <em>Person</em> objects are loaded from the database, including their related objects as defined. Therefore, none of the calls to <em>$identitySession-&gt;getRelatedObjects()</em> leads to a database query, but just returns the pre-fetched set of related objects.</p><a name="related-object-sub-sets"></a><a name="id37"></a><h4>Related object sub-sets</h4><p>In many cases it is not desirable to load all objects of a certain class and their related objects. Therefore it is possible, to restrict the loaded objects, using the typical query manipulations. However, this might often mean, that the set of related objects fetched for an object does not contain all related objects of a type, but only a sub-set.</p><p>To work around this potential inconsistencies, the concept of <em>named related
object sub-sets</em> was introduced:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$identitySession&nbsp;is&nbsp;an&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span></li>
<li></li>
<li><span style="color: #000000">$prefetchRelations&nbsp;</span><span style="color: #0000FF">=&nbsp;array(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'custom_addresses'&nbsp;</span><span style="color: #0000FF">=&gt;&nbsp;new&nbsp;</span><span style="color: #000000"><a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentRelationFindDefinition.html'>ezcPersistentRelationFindDefinition</a></span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$query&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">createFindQueryWithRelations</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$prefetchRelations</span></li>
<li><span style="color: #0000FF">);</span></li>
<li><span style="color: #000000">$query</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">where</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$query</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">gte</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'custom_addresses_zip'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">40000</span></li>
<li><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$query</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">lte</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'custom_addresses_zip'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">50000</span></li>
<li><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$persons&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">find</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$query&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;somewhere&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #0000FF">foreach&nbsp;(&nbsp;</span><span style="color: #000000">$persons&nbsp;</span><span style="color: #0000FF">as&nbsp;</span><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">)</span></li>
<li><span style="color: #0000FF">{</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$addresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjectSubset</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'custom_addresses'</span></li>
<li><span style="color: #335533">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">);</span></li>
<li><span style="color: #0000FF">}</span></li>
<li></li>
<span style="color: #000000">?&gt;</span>
</ol><p>In this example the query to fetch <em>Person</em> objects and their related <em>Address</em> objects has been restricted by a WHERE clause: Only the persons of which the <em>Address</em> lies between ZIP code <em>40000</em> and <em>50000</em> are fetched and only these addresses are loaded as related objects. A person that has two addresses, one with ZIP code <em>42235</em> and the other with <em>12345</em>, will be loaded with this query, but only one of its addresses is loaded. This is obviously not the full set of related objects of type <em>Address</em> for this person. Storing this set of <em>Address</em> objects in the identity map as usual would lead to inconsistencies.</p><p>Therefore, whenever you use a WHERE condition to restrict the set of loaded objects, a <em>named related object sub-set</em> is created. As can be seen in the example above, to fetch the pre-loaded <em>Address</em> objects for a <em>Person</em>, the method <em>$identity-&gt;getRelatedObjectSubset()</em> is used instead of <em>getRelatedObjects()</em>. This method receives the alias you have chosen before for a certain sub-set in the <em>$prefetchRelations</em> array. <em>'custom_addresses'</em> is the array key used to define the pre-fetching of <em>Address</em> objects.</p><p>For this reasons, the array keys used in the <em>$prefetchRelations</em> array must be unique on all levels, if you want to restrict the pre-fetching query using a WHERE condition. As shown in the example above, the keys used to define related objects to be loaded, are also used, to access these specific relations in the query. <em>'custom_addresses_zip'</em> is used to restrict on the property <em>$zip</em> of the <em>Address</em> objects to be fetched in the set <em>custom_addresses</em>.</p><p><strong>Note:</strong> Normal sets of related objects and named sub-sets can exist beside each other in the identity map. Whenever you use <em>addRelatedObject()</em>, all named related objects sub-sets will be removed from the identity map, since the mechanism can not detect to which of these the object must be added and to which not. However, using <em>removeRelatedObject()</em> and <em>delete()</em> do not have this side-effect, and will simply be reflected in the named sets, too.</p><p>Creating named sub-sets of related objects also works with the <em>createRelationFindQuery()</em> method, which already exists in <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSession.html'>ezcPersistentSession</a>. This method optionally receives a 4th parameter <em>$setName</em> on <a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a>, to define the set to store related objects found:</p><ol class="code">
<li><span style="color: #000000">&lt;?php</span></li>
<li><span style="color: #007700">//&nbsp;$identitySession&nbsp;is&nbsp;an&nbsp;<a href='/zetacomponents/documentation/trunk/PersistentObject/phpdoc/ezcPersistentSessionIdentityDecorator.html'>ezcPersistentSessionIdentityDecorator</a></span></li>
<li></li>
<li><span style="color: #000000">$person&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">load</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #335533">'Person'</span><span style="color: #0000FF">,&nbsp;</span><span style="color: #000000">23&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$query&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">createRelationFindQuery</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'Address'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">null</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'custom_addresses'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$query</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">where</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$query</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">gte</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'zip'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">40000</span></li>
<li><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$query</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">expr</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">lte</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'zip'</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">50000</span></li>
<li><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000FF">),</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #000000">$customAddresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">find</span><span style="color: #0000FF">(&nbsp;</span><span style="color: #000000">$query&nbsp;</span><span style="color: #0000FF">);</span></li>
<li></li>
<li><span style="color: #007700">//&nbsp;...&nbsp;some&nbsp;where&nbsp;else&nbsp;in&nbsp;your&nbsp;app&nbsp;...</span></li>
<li></li>
<li><span style="color: #000000">$sameCustomAddresses&nbsp;</span><span style="color: #0000FF">=&nbsp;</span><span style="color: #000000">$identitySession</span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">getRelatedObjectSubset</span><span style="color: #0000FF">(</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #000000">$person</span><span style="color: #0000FF">,</span></li>
<li><span style="color: #0000FF">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #335533">'custom_addresses'</span></li>
<li><span style="color: #0000FF">);</span></li>
<li></li>
<span style="color: #000000">?&gt;</span>
</ol><p>Retrieving the named sub-set of related objects works the same way before.</p><p>Note that there is no need to prefix the property names in the WHERE condition in this case. Since only one level of related objects can be loaded here, it is not necessary. Note also, that in this case, <em>Address</em> objects are only loaded for one specific <em>Person</em> and are not pre-fetched for any other <em>Person</em> object. Trying to access the created named related object sub-set for another <em>Person</em> will return <em>null</em> since these to do not exist.</p><p>You can also access the named related object sub-set just created, by using an equaling relation find query (which uses the same set name!). The identity mapping mechanism detects that you want to load this specific named set, determines that this is already loaded and simply returns it, instead of issuing another database query.</p><!--Local Variables:
mode: rst
fill-column: 79
End:
vim: et syn=rst tw=79-->

	</div>

	<div class="footer">
	Copyright  2010 <a href="http://apache.org">The Apache Software Foundation</a>
</div>
</div>
</body>
</html>
